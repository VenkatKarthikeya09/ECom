<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Checkout - Payment</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
<div th:replace="fragments/navbar :: navbar"></div>
<main class="container my-5 pt-5">
    <h3 class="mb-3">Payment</h3>

    <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

    <form method="post" action="/checkout/pay" id="payForm">
        <div class="accordion" id="paymentAccordion">
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingCard">
                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCard" aria-expanded="true" aria-controls="collapseCard" onclick="document.getElementById('method-card').checked=true;">
                        Card (Credit/Debit)
                    </button>
                </h2>
                <div id="collapseCard" class="accordion-collapse collapse" aria-labelledby="headingCard" data-bs-parent="#paymentAccordion">
                    <div class="accordion-body">
                        <input type="radio" name="method" id="method-card" value="CARD" class="d-none">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Card holder name</label>
                                <input class="form-control" name="cardHolder">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Card number</label>
                                <input class="form-control" name="cardNumber" minlength="12" maxlength="19">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Expiry month</label>
                                <input class="form-control" type="number" name="expiryMonth" min="1" max="12">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Expiry year</label>
                                <input class="form-control" type="number" name="expiryYear" min="2025" max="2100">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">CVV</label>
                                <input class="form-control" name="cvv" minlength="3" maxlength="4">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Bank</label>
                                <select class="form-select" name="bankName">
                                    <option value="">Select</option>
                                    <option>HDFC Bank</option>
                                    <option>ICICI Bank</option>
                                    <option>State Bank of India</option>
                                    <option>Axis Bank</option>
                                    <option>Kotak Mahindra Bank</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Payment reference</label>
                                <input class="form-control" name="referenceNumber" placeholder="Bank reference / Auth code">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Payer name</label>
                                <input class="form-control" name="payerName">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="accordion-item mt-2">
                <h2 class="accordion-header" id="headingUpi">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseUpi" aria-expanded="false" aria-controls="collapseUpi" onclick="document.getElementById('method-upi').checked=true;">
                        UPI
                    </button>
                </h2>
                <div id="collapseUpi" class="accordion-collapse collapse" aria-labelledby="headingUpi" data-bs-parent="#paymentAccordion">
                    <div class="accordion-body">
                        <input type="radio" name="method" id="method-upi" value="UPI_QR" class="d-none">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">UPI ID</label>
                                <div class="input-group">
                                    <input class="form-control" name="upiLocal" placeholder="yourname">
                                    <select class="form-select" style="max-width:180px" name="upiSuffix">
                                        <option value="@oksbi">@oksbi</option>
                                        <option value="@okhdfcbank">@okhdfcbank</option>
                                        <option value="@okaxis">@okaxis</option>
                                        <option value="@ybl">@ybl</option>
                                        <option value="@ibl">@ibl</option>
                                    </select>
                                </div>
                                <div class="small text-muted mt-2">Amount to pay: â‚¹ <span th:text="${#numbers.formatDecimal(orderTotal, 1, 'NONE', 2, 'POINT')}"></span></div>
                            </div>
                            <div class="col-md-6 text-center">
                                <div class="border p-3 rounded position-relative" style="min-height:240px;">
                                    <div id="qr-loading" class="text-muted">Generating QR... please wait</div>
                                    <img id="qr-img" alt="QR" class="img-fluid d-none" style="max-width:200px;">
                                    <div class="mt-2 small">Expires in <span id="qr-timer">03:00</span></div>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="alert alert-info py-2">Scan the QR with your UPI app or pay to the UPI ID above, then enter the reference below if needed.</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Payment reference</label>
                                <input class="form-control" name="referenceNumber" placeholder="UPI reference">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Payer name</label>
                                <input class="form-control" name="payerName">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="accordion-item mt-2">
                <h2 class="accordion-header" id="headingCod">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCod" aria-expanded="false" aria-controls="collapseCod" onclick="document.getElementById('method-cod').checked=true;">
                        Cash on Delivery
                    </button>
                </h2>
                <div id="collapseCod" class="accordion-collapse collapse" aria-labelledby="headingCod" data-bs-parent="#paymentAccordion">
                    <div class="accordion-body">
                        <input type="radio" name="method" id="method-cod" value="COD" class="d-none">
                        Pay with cash when your order is delivered.
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-3 d-flex justify-content-between">
            <a class="btn btn-outline-secondary" href="/checkout/review">Back to review</a>
            <button class="btn btn-gold">Place Order</button>
        </div>
    </form>
</main>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function(){
        const method = "[[${method}]]";
        if (method === 'CARD') {
            new bootstrap.Collapse(document.getElementById('collapseCard'), {toggle:true});
        } else if (method === 'UPI_QR') {
            new bootstrap.Collapse(document.getElementById('collapseUpi'), {toggle:true});
        } else if (method === 'COD') {
            new bootstrap.Collapse(document.getElementById('collapseCod'), {toggle:true});
        }

        const upiCollapse = document.getElementById('collapseUpi');
        let qrTimer;
        const startQrFlow = () => {
            const amount = '[[${#numbers.formatDecimal(orderTotal, 1, "NONE", 2, "POINT")}]]';
            const upiLocal = document.querySelector('input[name="upiLocal"]').value || 'eshop';
            const upiSuffix = document.querySelector('select[name="upiSuffix"]').value || '@oksbi';
            const pa = encodeURIComponent(upiLocal + upiSuffix);
            const pn = encodeURIComponent('E-Shop');
            const am = encodeURIComponent(amount);
            const data = `upi://pay?pa=${pa}&pn=${pn}&am=${am}`;
            const img = document.getElementById('qr-img');
            const loading = document.getElementById('qr-loading');
            const timerEl = document.getElementById('qr-timer');
            loading.classList.remove('d-none');
            img.classList.add('d-none');
            img.src = 'https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=' + encodeURIComponent(data) + '&_=' + Date.now();
            img.onload = () => {
                loading.classList.add('d-none');
                img.classList.remove('d-none');
            };
            // 3 minute countdown
            let remaining = 180;
            clearInterval(qrTimer);
            timerEl.textContent = '03:00';
            qrTimer = setInterval(() => {
                remaining -= 1;
                const m = String(Math.floor(remaining/60)).padStart(2,'0');
                const s = String(remaining%60).padStart(2,'0');
                timerEl.textContent = m + ':' + s;
                if (remaining <= 0) {
                    clearInterval(qrTimer);
                    // regenerate QR
                    startQrFlow();
                }
            }, 1000);
        };
        if (upiCollapse) {
            upiCollapse.addEventListener('shown.bs.collapse', startQrFlow);
        }
    });
</script>
</body>
</html> 